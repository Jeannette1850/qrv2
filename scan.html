<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Scan produit</title>

  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#121a33;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --accent1:#7c3aed;
      --accent2:#22c55e;
      --accent3:#f97316;

      --shadow: 0 30px 80px rgba(0,0,0,.55);
      --radius: 26px;
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(124,58,237,.45), transparent 55%),
        radial-gradient(800px 500px at 85% 20%, rgba(34,197,94,.32), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(249,115,22,.25), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px;
    }

    /* Halo anim√© */
    .glow{
      position: fixed;
      inset:-40%;
      background:
        radial-gradient(circle at 30% 30%, rgba(124,58,237,.20), transparent 40%),
        radial-gradient(circle at 70% 35%, rgba(34,197,94,.14), transparent 42%),
        radial-gradient(circle at 55% 70%, rgba(249,115,22,.12), transparent 45%);
      filter: blur(30px);
      animation: float 9s ease-in-out infinite;
      pointer-events:none;
      z-index:0;
    }
    @keyframes float{
      0%,100%{ transform: translate3d(0,0,0) scale(1); }
      50%{ transform: translate3d(0,-1.5%,0) scale(1.02); }
    }

    .wrap{ width:100%; max-width: 520px; position:relative; z-index:1; }

    /* Logo au-dessus de la carte */
    .topLogo{
      width: 50%;
      max-width: 240px;
      margin: 0 auto 14px;
      display:none; /* affich√© via JS si K1 OK */
      filter: drop-shadow(0 16px 30px rgba(0,0,0,.35));
    }
    .topLogo img{
      width:100%;
      height:auto;
      display:block;
      object-fit: contain;
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      transform: translateY(8px);
      opacity:0;
      animation: enter .55s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes enter{ to{ transform: translateY(0); opacity:1; } }

    .topbar{
      padding: 18px 18px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    /* Badge simple (sans logo dedans) */
    .brand-badge{
      width:36px; height:36px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(34,197,94,.75));
      box-shadow: 0 12px 30px rgba(124,58,237,.25);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.18);
      overflow:hidden;
      flex: 0 0 auto;
    }

    .brand-title{
      font-weight: 750;
      letter-spacing: .2px;
      font-size: 14px;
      color: rgba(255,255,255,.88);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-sub{
      font-size: 12px;
      color: var(--muted);
      margin-top:2px;
    }

    .pill{
      font-size: 12px;
      color: rgba(255,255,255,.82);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }

    /* On garde une zone header ‚Äúneutre‚Äù pour le chargement uniquement */
    .header{
      padding: 18px 22px 8px;
      display:flex;
      align-items:flex-start;
      gap:14px;
    }
    .statusIcon{
      width:52px; height:52px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      flex: 0 0 auto;
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
    }
    .statusIcon::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 40%);
      transform: rotate(15deg);
      opacity:.6;
    }

    .titles{ flex:1; min-width:0; padding-top:2px; }
    .title{
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height:1.15;
    }
    .subtitle{
      margin-top:6px;
      font-size: 13px;
      color: var(--muted);
      line-height:1.35;
    }

    .progress{
      height: 8px;
      margin: 10px 22px 0;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width: 15%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(34,197,94,.85));
      box-shadow: 0 10px 30px rgba(124,58,237,.25);
      transform-origin:left;
      animation: load 1.2s ease-in-out infinite;
    }
    @keyframes load{
      0%{ transform: scaleX(.25); opacity:.75; }
      60%{ transform: scaleX(1); opacity:1; }
      100%{ transform: scaleX(.35); opacity:.85; }
    }

    .body{ padding: 18px 22px 22px; }

    .row{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: 10px;
    }

    /* Ligne produit: image carr√©e √† gauche (1/3) + nom √† droite (2/3) */
    .productRow{
      display:flex;
      gap:12px;
      align-items:center;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      padding: 12px;
    }
    .thumbWrap{
      flex: 1 1 33%;
      max-width: 140px;
      min-width: 92px;
    }
    .thumb{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .productInfo{
      flex: 2 1 67%;
      min-width: 0;
    }
    .productName{
      font-size: 20px;
      font-weight: 860;
      letter-spacing:.2px;
      line-height:1.18;
      word-break: break-word;
    }

    .kv{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .kv .k{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.35px;
      text-transform: uppercase;
    }
    .kv .v{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 14px;
      color: rgba(255,255,255,.92);
      font-weight: 700;
      letter-spacing:.4px;
    }

    .notice{
      border-radius: 18px;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      line-height:1.5;
      font-size: 14px;
    }
    .notice.warn{
      border-color: rgba(249,115,22,.35);
      background: rgba(249,115,22,.10);
    }
    .notice.error{
      border-color: rgba(239,68,68,.38);
      background: rgba(239,68,68,.11);
    }

    .actions{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }

    .btn{
      flex:1 1 auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      cursor:pointer;
      text-decoration:none;
      color: rgba(255,255,255,.94);
      font-weight: 820;
      letter-spacing:.2px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.80));
      box-shadow: 0 18px 45px rgba(124,58,237,.20);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }
    .btn.ghost{ background: rgba(255,255,255,.06); box-shadow:none; }

    .countdown{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align:center;
    }

    .card[data-state="error"] .statusIcon{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.33);
    }
    .card[data-state="warn"] .statusIcon{
      background: rgba(249,115,22,.14);
      border-color: rgba(249,115,22,.35);
    }

    @media (prefers-reduced-motion: reduce){
      .glow, .bar, .card{ animation:none !important; }
      .card{ opacity:1; transform:none; }
    }

    @media (max-width: 420px){
      .title{ font-size: 18px; }
      .statusIcon{ width:48px; height:48px; border-radius: 16px; }
      .body{ padding: 16px 18px 18px; }
      .header{ padding: 16px 18px 6px; }
      .progress{ margin: 10px 18px 0; }
      .topbar{ padding: 16px 16px 0; }
      .thumbWrap{ max-width: 120px; min-width: 86px; }
      .productName{ font-size: 18px; }
      .topLogo{ width: 50%; max-width: 220px; }
    }
  </style>
</head>

<body>
  <div class="glow"></div>

  <div class="wrap">
    <!-- ‚úÖ Logo centr√© au-dessus de l'encart -->
    <div class="topLogo" id="topLogo">
      <img id="topLogoImg" alt="Logo entreprise" referrerpolicy="no-referrer">
    </div>

    <div class="card" id="card" data-state="loading">
      <div class="topbar">
        <div class="brand">
          <div class="brand-badge" aria-hidden="true">
            <!-- Ic√¥ne simple (sans logo entreprise ici) -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M7 4h-2a1 1 0 0 0-1 1v2" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M17 4h2a1 1 0 0 1 1 1v2" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 20h-2a1 1 0 0 1-1-1v-2" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M17 20h2a1 1 0 0 0 1-1v-2" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 12h10" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>

          <div style="min-width:0">
            <div class="brand-title">Authentification produit</div>
            <div class="brand-sub" id="brandSub">Scan & v√©rification</div>
          </div>
        </div>

        <div class="pill" id="pill">
          <span aria-hidden="true">‚è≥</span>
          <span id="pillText">Chargement</span>
        </div>
      </div>

      <!-- ‚úÖ Cette zone sert surtout au chargement / erreurs -->
      <div class="header" id="headerBlock">
        <div class="statusIcon" id="statusIcon" aria-hidden="true">
          <span id="emoji" style="font-size:22px; position:relative; z-index:1;">üîç</span>
        </div>

        <div class="titles">
          <div class="title" id="title">Recherche du produit‚Ä¶</div>
          <div class="subtitle" id="subtitle">Connexion √† la base et v√©rification des informations.</div>
        </div>
      </div>

      <div class="progress" id="progress">
        <div class="bar" id="bar"></div>
      </div>

      <div class="body">
        <div id="content" class="row">
          <div class="notice">Initialisation‚Ä¶</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrdt7iEq5I4nw7s8TBBKxuLhkbyTPN1hYHelrI2XmdeEKuI-2OAZDb1XOUXxMWFM1dUNv_A9Ww5jMj/pub?gid=0&single=true&output=csv";
  const $ = (id) => document.getElementById(id);

  function setState(state){
    $("card").dataset.state = state;
    const map = {
      loading: { pill:"Chargement", icon:"‚è≥", brand:"Scan & v√©rification" },
      success: { pill:"OK", icon:"‚úÖ", brand:"Informations compl√®tes üìã" },
      warn:    { pill:"Attention", icon:"‚ö†Ô∏è", brand:"V√©rification" },
      error:   { pill:"Erreur", icon:"‚ùå", brand:"Incident" }
    };
    $("pillText").textContent = map[state].pill;
    $("pill").querySelector("span").textContent = map[state].icon;
    $("brandSub").textContent = map[state].brand;
    $("progress").style.display = (state === "loading") ? "block" : "none";
  }

  function getParam(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function cleanGtin(x) {
    return (x || "").toString().trim().replace(/[^0-9]/g, "");
  }

  function toHttps(url){
    if (!url) return "";
    const u = url.trim();
    if (!u) return "";
    if (u.startsWith("https://")) return u;
    if (u.startsWith("http://")) return "https://" + u.slice("http://".length); // √©vite mixed content iOS
    if (u.startsWith("//")) return "https:" + u;
    if (u.startsWith("data:")) return u;
    return "https://" + u;
  }

  function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    return lines.map(line => {
      const out = [];
      let cur = "", inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          out.push(cur); cur = "";
        } else cur += ch;
      }
      out.push(cur);
      return out.map(s => s.trim());
    });
  }

  function kv(label, value){
    return `
      <div class="kv">
        <div class="k">${label}</div>
        <div class="v">${value}</div>
      </div>
    `;
  }

  function showError(message) {
    setState("error");
    $("emoji").textContent = "‚ùå";
    $("title").textContent = "Une erreur est survenue";
    $("subtitle").textContent = "Impossible de poursuivre la v√©rification pour le moment.";
    $("content").innerHTML = `
      <div class="notice error">${message}</div>
      <div class="actions">
        <button class="btn ghost" id="retryBtn" type="button">‚Üª R√©essayer</button>
      </div>
    `;
    $("retryBtn").onclick = () => window.location.reload();
  }

  function showInactive(nom, gtin) {
    setState("warn");
    $("emoji").textContent = "‚ö†Ô∏è";
    $("title").textContent = "Produit d√©sactiv√©";
    $("subtitle").textContent = "Ce produit n‚Äôest pas disponible actuellement.";
    $("content").innerHTML = `
      <div class="notice warn">
        Ce produit a √©t√© temporairement d√©sactiv√© ou n‚Äôest plus commercialis√©.
        Si besoin, contactez le service client √† conso@jeannette1850.com.
      </div>
      ${kv("EAN", gtin)}
    `;
  }

  function productRowHTML(nom, imageUrl){
    const safeImg = (imageUrl || "").trim();
    const imgPart = safeImg ? `
      <div class="thumbWrap">
        <div class="thumb">
          <img src="${safeImg}" alt="${(nom||"Produit").replace(/"/g,'&quot;')}"
               referrerpolicy="no-referrer"
               onerror="this.closest('.thumbWrap').style.display='none'">
        </div>
      </div>
    ` : `<div class="thumbWrap" style="display:none"></div>`;

    return `
      <div class="productRow">
        ${imgPart}
        <div class="productInfo">
          <div class="productName">${nom || "Produit"}</div>
        </div>
      </div>
    `;
  }

  // ‚úÖ Succ√®s: on SUPPRIME le bloc "Produit authentifi√© / redirection ..." + la coche (pas affich√©)
  function showSuccess(nom, gtin, url, imageUrl) {
    setState("success");

    // On ‚Äúneutralise‚Äù l'en-t√™te (plus de message succ√®s)
    $("emoji").textContent = "üîç";
    $("title").textContent = "";
    $("subtitle").textContent = "";
    $("headerBlock").style.display = "none"; // ‚úÖ supprime tout le bloc

    let countdown = 3;

    $("content").innerHTML = `
      ${productRowHTML(nom, imageUrl)}
      ${kv("EAN", gtin)}

      <div class="actions">
        <button class="btn" id="openBtn" type="button">Voir la fiche produit</button>
      </div>

      <div class="countdown" id="countdown">Redirection dans ${countdown} secondes‚Ä¶</div>
    `;

    $("openBtn").onclick = () => window.location.href = url;

    const interval = setInterval(() => {
      countdown--;
      const el = $("countdown");
      if (!el) return clearInterval(interval);

      if (countdown > 0) {
        el.textContent = `Redirection dans ${countdown} seconde${countdown>1?"s":""}‚Ä¶`;
      } else {
        clearInterval(interval);
        window.location.href = url;
      }
    }, 1000);
  }

  function showNotFound(gtin) {
    setState("error");
    $("headerBlock").style.display = "flex";
    $("emoji").textContent = "üîé";
    $("title").textContent = "Produit introuvable";
    $("subtitle").textContent = "Aucune correspondance dans la base.";
    $("content").innerHTML = `
      ${kv("EAN", gtin)}
      <div class="notice error">
        Aucun produit ne correspond √† ce code-barres.
        V√©rifiez le scan ou contactez le service client √† conso@jeannette1850.com.
      </div>
      <div class="actions">
        <button class="btn ghost" id="retryBtn" type="button">‚Üª Re-scanner</button>
      </div>
    `;
    $("retryBtn").onclick = () => window.location.reload();
  }

  function applyCompanyLogo(rows){
    // K1 => ligne 1 / colonne K (index 10)
    const raw = (rows?.[0]?.[10] || "").trim();
    const logoUrl = toHttps(raw);
    const topLogo = $("topLogo");
    const img = $("topLogoImg");

    if (!logoUrl) {
      topLogo.style.display = "none";
      return;
    }

    img.onload = () => { topLogo.style.display = "block"; };
    img.onerror = () => { topLogo.style.display = "none"; };

    img.src = logoUrl;
  }

  async function run() {
    setState("loading");
    $("headerBlock").style.display = "flex";

    const gtin = cleanGtin(getParam("gtin") || getParam("GTIN"));
    if (!gtin) {
      showError(`Aucun code produit (GTIN) fourni dans l'URL.<br><br>Exemple : <code style="background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px;">?gtin=1234567890123</code>`);
      return;
    }

    $("content").innerHTML = `
      ${kv("EAN", gtin)}
      <div class="notice">Recherche dans la base de donn√©es‚Ä¶</div>
    `;

    let csv = "";
    try {
      const resp = await fetch(CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "_=" + Date.now(), { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP");
      csv = await resp.text();
    } catch (e) {
      showError("Impossible de charger la base de donn√©es.<br><br>V√©rifiez que le fichier CSV est bien publi√© et accessible.");
      return;
    }

    const rows = parseCSV(csv);

    // ‚úÖ Logo entreprise K1 (affich√© au-dessus de la carte)
    applyCompanyLogo(rows);

    // Colonnes:
    // A=0 GTIN, B=1 Nom, C=2 URL fiche, E=4 Image, H=7 Actif
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      const gtinSheet = cleanGtin(r[0] || "");
      const nom = r[1] || "";
      const urlRaw = (r[2] || "").trim();
      const imageUrlRaw = (r[4] || "").trim(); // Colonne E
      const actif = (r[7] || "").toString().trim().toLowerCase();

      if (gtinSheet === gtin) {
        if (actif === "non") { showInactive(nom, gtin); return; }

        if (!urlRaw) {
          showError(`Produit trouv√© : <strong>${nom || "Sans nom"}</strong><br><br>Mais aucune URL de destination n'est configur√©e.`);
          return;
        }

        const finalUrl = toHttps(urlRaw);
        const imageUrl = toHttps(imageUrlRaw);

        showSuccess(nom, gtin, finalUrl, imageUrl);
        return;
      }
    }

    showNotFound(gtin);
  }

  run();
</script>
</body>
</html>


